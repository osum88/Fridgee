// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//uzivatele
model User {
  id                           Int                   @id @default(autoincrement())
  name                         String?               @db.VarChar(40)
  surname                      String?               @db.VarChar(40)
  username                     String                @unique @db.VarChar(30)
  birthDate                    DateTime?             @map("birth_date")
  email                        String                @unique
  gender                       Gender?               @default(UNSPECIFIED)
  country                      String?               @db.VarChar(10)
  passwordHash                 String                @map("password_hash")
  profilePictureUrl            String?               @map("profile_picture_url")
  emailIsVerified              Boolean               @default(false) @map("email_is_verified")
  verificationToken            String?               @unique @map("verification_token")
  tokenExpiresAt               DateTime?             @map("token_expires_at")
  passwordResetToken           String?               @unique @map("password_reset_token")
  passwordResetExpiresAt       DateTime?             @map("password_reset_expires_at")
  bankNumber                   String?               @map("bank_number") @db.VarChar(70)
  isAdmin                      Boolean               @default(false) @map("is_admin")
  createdAt                    DateTime              @default(now()) @map("created_at")
  lastLogin                    DateTime              @default(now()) @map("last_login")
  updatedAt                    DateTime              @updatedAt @map("updated_at")
  preferredLanguage            String                @default("en") @map("preferred_language")
  refreshTokens                RefreshToken[]
  sentFriendships              Friendship[]          @relation("sentFriendships")
  receivedFriendships          Friendship[]          @relation("receivedFriendships")
  userInventory                InventoryUser[]       @relation("userInventory")
  sentInventoryInvitations     InventoryInvitation[] @relation("sentInvitations")
  receivedInventoryInvitations InventoryInvitation[] @relation("receivedInvitations")
  foodCatalog                  FoodCatalog[]
  foodInstancesAdded           FoodInstance[]
  foodHistory                  FoodHistory[]
  foodLabel                    FoodLabel[]
  foodVariantsAdded            FoodVariant[]

  @@map("users")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

// refresh tokeny
model RefreshToken {
  id        String   @id
  tokenHash String   @unique @map("token_hash")
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("create_at")
  isValid   Boolean  @default(true) @map("is_valid")

  @@map("refresh_token")
}

//pratelstvi
model Friendship {
  id         Int              @id @default(autoincrement())
  sender     User             @relation("sentFriendships", fields: [senderId], references: [id], onDelete: Cascade)
  senderId   Int              @map("sender_id")
  receiver   User             @relation("receivedFriendships", fields: [receiverId], references: [id], onDelete: Cascade)
  receiverId Int              @map("receiver_id")
  status     FriendshipStatus @default(PENDING)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  @@unique([senderId, receiverId])
  @@map("friendships")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

//inventar potravin
model FoodInventory {
  id              Int                   @id @default(autoincrement())
  title           String                @db.VarChar(50)
  label           String?               @db.VarChar(100)
  isArchived      Boolean               @default(false) @map("is_archived")
  memberCount     Int                   @default(0) @map("member_count")
  lastActivityAt  DateTime              @default(now()) @map("last_activity_at")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  inventory       InventoryUser[]       @relation("inventory")
  sentInvitations InventoryInvitation[] @relation("inventoryInvitations")
  foods           Food[]
  foodCategory    FoodCategory[]
  foodHistory     FoodHistory[]

  @@map("food_inventory")
}

//uzivatele jednoho inventare
model InventoryUser {
  id                   Int           @id @default(autoincrement())
  user                 User          @relation("userInventory", fields: [userId], references: [id], onDelete: Cascade)
  userId               Int           @map("user_id")
  inventory            FoodInventory @relation("inventory", fields: [inventoryId], references: [id], onDelete: Cascade)
  inventoryId          Int           @map("inventory_id")
  role                 InventoryRole @default(USER)
  joinedAt             DateTime      @default(now()) @map("joined_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  notificationSettings Json          @default("{}") @map("notification_settings")

  @@unique([userId, inventoryId])
  @@map("inventory_users")
}

enum InventoryRole {
  OWNER
  EDITOR
  USER
}

//pozvanka do inventare
model InventoryInvitation {
  id          Int              @id @default(autoincrement())
  sender      User             @relation("sentInvitations", fields: [senderId], references: [id], onDelete: Cascade)
  senderId    Int              @map("sender_id")
  receiver    User             @relation("receivedInvitations", fields: [receiverId], references: [id], onDelete: Cascade)
  receiverId  Int              @map("receiver_id")
  inventory   FoodInventory    @relation("inventoryInvitations", fields: [inventoryId], references: [id], onDelete: Cascade)
  inventoryId Int              @map("inventory_id")
  role        InventoryRole    @default(USER)
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@unique([senderId, receiverId, inventoryId])
  @@map("inventory_invitations")
}

enum InvitationStatus {
  PENDING
}

//katalog potravin, slouzi pro predvyplneni
model FoodCatalog {
  id          Int           @id @default(autoincrement())
  barcode     String?       @db.VarChar(150)
  addedBy     Int?           @map("added_by")
  isDeleted   Boolean       @default(false) @map("is_deleted")
  createdAt   DateTime      @default(now()) @map("created_at")
  updateAt    DateTime      @updatedAt @map("update_at")
  user        User?          @relation(fields: [addedBy], references: [id])
  variants    FoodVariant[]
  foods       Food[]
  labels      FoodLabel[]
  foodHistories FoodHistory[]

  @@index([barcode, addedBy])
  @@index([barcode])
  @@map("food_catalogs")
}

enum Unit {
  MG
  G
  DG
  KG
  ML
  CL
  DL
  L
}

// reprezentuje konkretni potravinu v inventari
model Food {
  id              Int            @id @default(autoincrement())
  inventoryId     Int            @map("inventory_id")
  categoryId      Int?           @map("category_id")
  catalogId       Int            @map("catalog_id")
  variantId       Int?           @map("variant_id")
  defaultLabelId  Int?           @map("default_label_id")
  minimalQuantity Int            @default(0) @map("minimal_quantity")
  createdAt       DateTime       @default(now()) @map("created_at")
  updateAt        DateTime       @updatedAt @map("update_at")
  inventory       FoodInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  catalog         FoodCatalog    @relation(fields: [catalogId], references: [id])
  variant         FoodVariant?   @relation(fields: [variantId], references: [id], onDelete: SetNull)
  category        FoodCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  label           FoodLabel?     @relation(fields: [defaultLabelId], references: [id], onDelete: SetNull)
  instances       FoodInstance[]
  history         FoodHistory[]

  @@unique([inventoryId, catalogId, variantId])
  @@index([inventoryId, catalogId])
  @@map("foods")
}

// konkretni instance jednoho jidla
model FoodInstance {
  id             Int           @id @default(autoincrement())
  foodId         Int           @map("food_id")
  priceId        Int?          @map("price_id")
  expirationDate DateTime?     @map("expiration_date")
  addedBy        Int?          @map("added_by")
  unit           Unit?
  amount         Float         @default(0)
  createdAt      DateTime      @default(now()) @map("created_at")
  updateAt       DateTime      @updatedAt @map("update_at")
  addedByUser    User?         @relation(fields: [addedBy], references: [id], onDelete: SetNull)
  food           Food          @relation(fields: [foodId], references: [id], onDelete: Cascade)
  price          Price?        @relation(fields: [priceId], references: [id], onDelete: SetNull)
  history        FoodHistory[]

  @@index([foodId])
  @@index([foodId, addedBy])
  @@map("food_instances")
}

// ruzne verze potraviny (mouka - hladná, hrubá..)
model FoodVariant {
  id            Int         @id @default(autoincrement())
  foodCatalogId Int         @map("food_catalog_id")
  title         String      @db.VarChar(40)
  addedBy       Int?        @map("added_by")
  isDeleted     Boolean     @default(false) @map("is_deleted")
  createdAt     DateTime    @default(now()) @map("created_at")
  catalog       FoodCatalog @relation(fields: [foodCatalogId], references: [id], onDelete: Cascade)
  foods         Food[]
  user          User?       @relation(fields: [addedBy], references: [id], onDelete: SetNull)

  @@index([title, foodCatalogId, addedBy])
  @@index([foodCatalogId])
  @@map("food_variants")
}

// kategorie jidel vramci jednoho inventare
model FoodCategory {
  id          Int           @id @default(autoincrement())
  inventoryId Int           @map("inventory_id")
  title       String        @db.VarChar(50)
  createdAt   DateTime      @default(now()) @map("created_at")
  inventory   FoodInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  foods       Food[]

  @@index([inventoryId])
  @@map("food_categories")
}

// castka v ruznych menach
model Price {
  id               Int            @id @default(autoincrement())
  price            Float          @default(0)
  baseCurrency     Currency       @default(CZK) @map("base_currency")
  exchangeAmount   Json           @default("{}") @map("exchange_amount")
  exchangeRate     Json           @default("{}") @map("exchange_rate")
  exchangeRateDate DateTime       @map("exchange_rate_date")
  createdAt        DateTime       @default(now()) @map("created_at")
  foodInstances    FoodInstance[]
  foodHistory      FoodHistory[]

  @@map("prices")
}

//enum men
enum Currency {
  CZK
  EUR
}

//historie vsech operaci nad jidlem
model FoodHistory {
  id             Int        @id @default(autoincrement())
  inventoryId    Int        @map("inventory_id")
  foodId         Int?       @map("food_id")
  foodInstanceId Int?       @map("food_instance_id")
  catalogId      Int        @map("catalog_id")
  priceId        Int?       @map("price_id")
  action         FoodAction @default(ADD)
  snapshotUnit   Unit?      @map("snapshot_unit")
  snapshotAmount Float?     @map("snapshot_amount")
  quantityBefore Int        @default(0) @map("quantity_before")
  quantityAfter  Int        @map("quantity_after")
  changedBy      Int?       @map("changed_by")
  changedAt      DateTime   @default(now()) @map("changed_at")
  metadata       Json       @default("{}") @map("metadata")

  user      User?         @relation(fields: [changedBy], references: [id], onDelete: SetNull)
  catalog   FoodCatalog   @relation(fields: [catalogId], references: [id])
  price     Price?        @relation(fields: [priceId], references: [id], onDelete: SetNull)
  food      Food?         @relation(fields: [foodId], references: [id], onDelete: SetNull)
  instance  FoodInstance? @relation(fields: [foodInstanceId], references: [id], onDelete: SetNull)
  inventory FoodInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([inventoryId, changedBy])
  @@index([inventoryId, changedBy, action])
  @@index([inventoryId, action])
  @@map("food_histories")
}

// enum akci v historii jidel
enum FoodAction {
  ADD
  CONSUME
  UPDATE
  EXPIRE
  REMOVE
}

// pridava moznost prepsat nazev, popisek, obrazek v katalogu vlastnim
model FoodLabel {
  id           Int      @id @default(autoincrement())
  userId       Int?      @map("user_id")
  catalogId    Int      @map("catalog_id")
  title        String?  @map("title") @db.VarChar(40)
  description  String?  @map("description") @db.VarChar(100)
  foodImageUrl String?  @map("food_image_url") @db.VarChar(250)
  price        Float    @default(0)
  unit         Unit?
  amount       Float    @default(0)
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user    User?        @relation(fields: [userId], references: [id])
  catalog FoodCatalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  foods    Food[]

  @@index([userId, catalogId])
  @@index([catalogId])
  @@map("food_labels")
}

model ExchangeRate {
  id                    Int      @id @default(autoincrement())
  amount                Float    @default(0)
  country               String   @db.VarChar(50)
  currencyCode          String   @map("currency_code") @db.VarChar(3)
  convertedCurrencyCode String   @map("converted_currency_code") @db.VarChar(3)
  rate                  Float    @default(0)
  exchangeRateDate      DateTime @map("exchange_rate_date")

  @@unique([currencyCode, convertedCurrencyCode])
  @@map("exchange_rates")
}
